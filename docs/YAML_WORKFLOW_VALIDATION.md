# YAML Workflow Validation (manual + scripted)

## Summary
- Workflow file: `.github/workflows/docker-build-push.yml`
- Validation run: attempted locally from this environment on 2025-12-09 UTC
- Result: I prepared a Node validator script (`scripts/validate_yaml.js`) but Node/npm are not installed in this environment, so the linter could not be executed here. I recorded the parsing issues discovered during inspection and the subsequent fixes below for future reference.

## Environment note
- Node/npm not found in the current execution environment; to run the Node validator locally, use the commands below:

```powershell
cd ./scripts
npm install
node validate_yaml.js
```

or from the repository root:

```powershell
cd C:\path\to\TheThroneOfGames
npm --prefix ./scripts install
node ./scripts/validate_yaml.js
```

The validator writes `docs/YAML_WORKFLOW_VALIDATION.md` (this file) and exits with non-zero code when parse errors are found.

## Issues found (manual inspection)
1. Inline `run:` step contained an embedded newline/line-wrap that broke YAML parsing.
   - Location: `build-and-push` job, `- name: Image digest` step (reported by GitHub at line 68)
   - Symptom: The `run:` scalar was split across a newline: `...outputs.d\nigest` causing the YAML parser to see an invalid scalar.
   - Fix applied: Converted the `run:` scalar to a block scalar:
     ```yaml
     - name: Image digest
       run: |
         echo "Image pushed with digest: ${{ steps.build.outputs.digest }}"
     ```

2. `cache-to` inline parameter formatting
   - Original: `cache-to: type=gha,mode=max`
   - YAML may accept this, but to be safer/clearer the string was adjusted to include a space after the comma.
   - Fix applied: `cache-to: type=gha, mode=max`

3. Workflow triggers used branches not present in this repo
   - Original triggers: `branches: [ main, develop ]`
   - Repo branches: this repository uses `master`, `Develop`, `revisao-objetive1`, etc.
   - Fix applied: updated triggers to `branches: [ master, Develop ]` to match the repository's branch names.

4. Deprecated action usage
   - `actions/upload-artifact@v3` is deprecated (per GitHub deprecation notice).
   - Fix applied: updated to `actions/upload-artifact@v4`.

## Other checks performed
- Verified file for non-printable characters and hidden CR/LF issues.
- Performed local `dotnet build` earlier; solution builds successfully with 0 errors and 12 warnings (package version concerns only).

## Files added to help future validation
- `scripts/validate_yaml.js` - Node script to parse the workflow using `js-yaml` and write a report.
- `scripts/package.json` - package manifest with `js-yaml` dependency.

## Commits created
- `ci: use block scalar for image digest run step to avoid YAML parsing issues` (fixed inline run scalar)
- `fix: correct YAML syntax and branch names in docker-build-push.yml workflow` (branch triggers & cache-to spacing)
- `ci: update upload-artifact to v4 (fix deprecation)` (update deprecated action)
- `chore: commit and push requested changes` (misc commit)
- `docs: add workflow fix summary` (earlier summary file)

## Suggested local validation steps (run on your machine)
1. Ensure Node.js (>=16) and npm are installed.
2. From repo root:
```powershell
npm --prefix ./scripts install
node ./scripts/validate_yaml.js
```
3. Confirm `docs/YAML_WORKFLOW_VALIDATION.md` is updated and review any parsing errors reported.
4. If you want CI to re-validate now, push an empty commit to trigger Actions (or open the Actions tab):
```powershell
git commit --allow-empty -m "ci: trigger workflow validation" && git push
```

---

*Generated by automation on 2025-12-09 UTC.*
