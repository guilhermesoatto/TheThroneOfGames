name: CI/CD Pipeline - Build, Test & Performance

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  DOCKER_BUILDKIT: 1

jobs:
  # Job 1: Build e Testes UnitÃ¡rios
  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore TheThroneOfGames.sln
      
    - name: ðŸ—ï¸ Build solution
      run: dotnet build TheThroneOfGames.sln --configuration Release --no-restore
      
    - name: ðŸ§ª Run unit tests
      run: dotnet test TheThroneOfGames.sln --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
      
    - name: ðŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/TestResults/**'
        
    - name: ðŸ“ˆ Upload coverage reports
      if: always()
      uses: codecov/codecov-action@v4
      with:
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

  # Job 2: Build Docker Images
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    strategy:
      matrix:
        service:
          - name: usuarios-api
            context: .
            dockerfile: GameStore.Usuarios.API/Dockerfile
          - name: catalogo-api
            context: .
            dockerfile: GameStore.Catalogo.API/Dockerfile
          - name: vendas-api
            context: .
            dockerfile: GameStore.Vendas.API/Dockerfile
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ—ï¸ Build Docker image - ${{ matrix.service.name }}
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service.context }}
        file: ${{ matrix.service.dockerfile }}
        push: false
        tags: thethroneofgames-${{ matrix.service.name }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/${{ matrix.service.name }}.tar
        
    - name: ðŸ“¦ Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image-${{ matrix.service.name }}
        path: /tmp/${{ matrix.service.name }}.tar
        retention-days: 1

  # Job 3: Performance Tests
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    needs: docker-build
    
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: YourSecurePassword123!
          ACCEPT_EULA: Y
        ports:
          - 1433:1433
        options: >-
          --health-cmd="/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourSecurePassword123! -Q 'SELECT 1' || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      rabbitmq:
        image: rabbitmq:3.12-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download Docker images
      uses: actions/download-artifact@v4
      with:
        pattern: docker-image-*
        path: /tmp/docker-images
        
    - name: ðŸ³ Load Docker images
      run: |
        docker load --input /tmp/docker-images/docker-image-usuarios-api/usuarios-api.tar
        docker load --input /tmp/docker-images/docker-image-catalogo-api/catalogo-api.tar
        docker load --input /tmp/docker-images/docker-image-vendas-api/vendas-api.tar
        docker images
        
    - name: ðŸ·ï¸ Tag Docker images
      run: |
        docker tag thethroneofgames-usuarios-api:${{ github.sha }} thethroneofgames-usuarios-api:latest
        docker tag thethroneofgames-catalogo-api:${{ github.sha }} thethroneofgames-catalogo-api:latest
        docker tag thethroneofgames-vendas-api:${{ github.sha }} thethroneofgames-vendas-api:latest
        
    - name: ðŸš€ Start microservices
      run: |
        # Usuarios API
        docker run -d --name usuarios-api --network host \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Server=localhost,1433;Database=GameStore;User=sa;Password=YourSecurePassword123!;TrustServerCertificate=True" \
          -e Jwt__Key="your-super-secret-key-that-is-at-least-32-characters-long!" \
          -e EventBus__RabbitMq__HostName="localhost" \
          thethroneofgames-usuarios-api:latest
          
        # Catalogo API
        docker run -d --name catalogo-api --network host \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Server=localhost,1433;Database=GameStore;User=sa;Password=YourSecurePassword123!;TrustServerCertificate=True" \
          -e EventBus__RabbitMq__HostName="localhost" \
          thethroneofgames-catalogo-api:latest
          
        # Vendas API
        docker run -d --name vendas-api --network host \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Server=localhost,1433;Database=GameStore;User=sa;Password=YourSecurePassword123!;TrustServerCertificate=True" \
          -e EventBus__RabbitMq__HostName="localhost" \
          thethroneofgames-vendas-api:latest
          
    - name: â³ Wait for services to be ready
      run: |
        echo "Waiting for services to start..."
        sleep 30
        
        # Check if services are responding
        for port in 5001 5002 5003; do
          echo "Checking port $port..."
          for i in {1..30}; do
            if curl -f http://localhost:$port/swagger > /dev/null 2>&1; then
              echo "Port $port is ready!"
              break
            fi
            echo "Waiting... attempt $i/30"
            sleep 2
          done
        done
        
    - name: ðŸ“Š Show container status
      if: always()
      run: |
        echo "=== Container Status ==="
        docker ps -a
        echo ""
        echo "=== Usuarios API Logs ==="
        docker logs usuarios-api --tail 50
        echo ""
        echo "=== Catalogo API Logs ==="
        docker logs catalogo-api --tail 50
        echo ""
        echo "=== Vendas API Logs ==="
        docker logs vendas-api --tail 50
        
    - name: ðŸ”§ Install PowerShell
      run: |
        sudo apt-get update
        sudo apt-get install -y powershell
        
    - name: âš¡ Run quick performance tests
      run: |
        pwsh -File ./scripts/quick-performance-test.ps1 -BaseUrl "http://localhost" -Duration 30 -ConcurrentUsers 5
        
    - name: ðŸ“Š Upload performance results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: quick-performance-results.json
        
    - name: ðŸ“ˆ Display performance summary
      if: always()
      run: |
        if [ -f quick-performance-results.json ]; then
          echo "=== Performance Test Results ==="
          cat quick-performance-results.json | jq '.'
        fi
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker stop usuarios-api catalogo-api vendas-api || true
        docker rm usuarios-api catalogo-api vendas-api || true

  # Job 4: Security Scan (opcional)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [usuarios-api, catalogo-api, vendas-api]
    
    steps:
    - name: ðŸ“¦ Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image-${{ matrix.service }}
        path: /tmp
        
    - name: ðŸ³ Load Docker image
      run: docker load --input /tmp/${{ matrix.service }}.tar
      
    - name: ðŸ”’ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: thethroneofgames-${{ matrix.service }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results-${{ matrix.service }}.sarif'
        severity: 'CRITICAL,HIGH'
        
    - name: ðŸ“¤ Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

  # Job 5: Summary Report
  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build, performance-tests]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: ðŸ“ Generate summary
      run: |
        echo "# ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f artifacts/performance-results/quick-performance-results.json ]; then
          echo "## ðŸ“Š Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat artifacts/performance-results/quick-performance-results.json | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: âœ… Success notification
      if: success()
      run: echo "ðŸŽ‰ All jobs completed successfully!"
      
    - name: âŒ Failure notification
      if: failure()
      run: echo "âš ï¸ Some jobs failed. Check the logs above."
  # Job 6: Deploy to GKE
  deploy-gke:
    name: Deploy to Google Kubernetes Engine
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build, performance-tests]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
        
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: ðŸ³ Configure Docker for GCR
      run: |
        gcloud auth configure-docker
        
    - name: ðŸ“¦ Download Docker images
      uses: actions/download-artifact@v4
      with:
        pattern: docker-image-*
        path: /tmp/docker-images
        
    - name: ðŸ³ Load and Push Docker images to GCR
      run: |
        # Load images
        docker load --input /tmp/docker-images/docker-image-usuarios-api/usuarios-api.tar
        docker load --input /tmp/docker-images/docker-image-catalogo-api/catalogo-api.tar
        docker load --input /tmp/docker-images/docker-image-vendas-api/vendas-api.tar
        
        # Tag for GCR
        docker tag thethroneofgames-usuarios-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/usuarios-api:${{ github.sha }}
        docker tag thethroneofgames-usuarios-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/usuarios-api:latest
        
        docker tag thethroneofgames-catalogo-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalogo-api:${{ github.sha }}
        docker tag thethroneofgames-catalogo-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalogo-api:latest
        
        docker tag thethroneofgames-vendas-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/vendas-api:${{ github.sha }}
        docker tag thethroneofgames-vendas-api:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/vendas-api:latest
        
        # Push to GCR
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/usuarios-api:${{ github.sha }}
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/usuarios-api:latest
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalogo-api:${{ github.sha }}
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalogo-api:latest
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/vendas-api:${{ github.sha }}
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/vendas-api:latest
        
    - name: ðŸŽ¯ Get GKE credentials
      run: |
        gcloud container clusters get-credentials autopilot-cluster-1 \
          --region southamerica-east1 \
          --project ${{ secrets.GCP_PROJECT_ID }}
        
    - name: ðŸ“ Update Kubernetes manifests with new image tags
      run: |
        # Update image tags in Kubernetes manifests
        sed -i "s|image: gcr.io/.*/usuarios-api:.*|image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/usuarios-api:${{ github.sha }}|g" k8s/deployments/usuarios-api.yaml
        sed -i "s|image: gcr.io/.*/catalogo-api:.*|image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalogo-api:${{ github.sha }}|g" k8s/deployments/catalogo-api.yaml
        sed -i "s|image: gcr.io/.*/vendas-api:.*|image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/vendas-api:${{ github.sha }}|g" k8s/deployments/vendas-api.yaml
        
    - name: ðŸš€ Deploy to GKE using kubectl
      run: |
        # Create namespace if not exists
        kubectl create namespace thethroneofgames --dry-run=client -o yaml | kubectl apply -f -
        
        # Apply ConfigMaps and Secrets first
        kubectl apply -f k8s/configmaps.yaml
        kubectl apply -f k8s/secrets.yaml
        
        # Deploy services
        kubectl apply -f k8s/deployments/usuarios-api.yaml
        kubectl apply -f k8s/deployments/catalogo-api.yaml
        kubectl apply -f k8s/deployments/vendas-api.yaml
        
        # Apply HPA
        kubectl apply -f k8s/hpa.yaml
        
        # Apply Ingress
        kubectl apply -f k8s/ingress.yaml
        
    - name: â³ Wait for deployments to be ready
      run: |
        echo "Waiting for deployments to be ready..."
        kubectl wait --for=condition=available --timeout=300s deployment/usuarios-api
        kubectl wait --for=condition=available --timeout=300s deployment/catalogo-api
        kubectl wait --for=condition=available --timeout=300s deployment/vendas-api
        
    - name: ðŸ“Š Get deployment status
      if: always()
      run: |
        echo "=== Deployments ==="
        kubectl get deployments
        echo ""
        echo "=== Pods ==="
        kubectl get pods
        echo ""
        echo "=== Services ==="
        kubectl get services
        echo ""
        echo "=== HPA ==="
        kubectl get hpa
        echo ""
        echo "=== Ingress ==="
        kubectl get ingress
        
    - name: ðŸŒ Get service URLs
      run: |
        echo "=== Service URLs ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        INGRESS_IP=$(kubectl get ingress -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}')
        echo "- **Ingress IP**: $INGRESS_IP" >> $GITHUB_STEP_SUMMARY
        echo "- **Usuarios API**: http://$INGRESS_IP/usuarios" >> $GITHUB_STEP_SUMMARY
        echo "- **Catalogo API**: http://$INGRESS_IP/catalogo" >> $GITHUB_STEP_SUMMARY
        echo "- **Vendas API**: http://$INGRESS_IP/vendas" >> $GITHUB_STEP_SUMMARY