# Default Helm values for TheThroneOfGames chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
global:
  environment: "production"  # development, staging, production
  domain: "thethroneofgames.com"
  imagePullPolicy: "Always"
  imagePullSecrets:
    - name: docker-registry-credentials

# Namespace configuration
namespace:
  create: true
  name: thethroneofgames

# API Deployment settings
api:
  enabled: true
  
  # Image configuration
  image:
    repository: "thethroneofgames/api"
    tag: "latest"
    pullPolicy: "Always"
  
  # Replica settings (base replicas, HPA overrides this)
  replicas: 3
  
  # Resource limits and requests
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  # Health check configuration
  healthCheck:
    liveness:
      enabled: true
      path: /health
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      enabled: true
      path: /health/ready
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    startup:
      enabled: true
      path: /health/startup
      initialDelaySeconds: 0
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 30
  
  # Service configuration
  service:
    type: LoadBalancer  # LoadBalancer, NodePort, ClusterIP
    port: 80
    targetPort: 5000
    metricsPort: 9090
  
  # Ingress configuration
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/rate-limit: "100"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - host: "api.thethroneofgames.com"
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: api-tls-certificate
        hosts:
          - "api.thethroneofgames.com"
  
  # Autoscaling configuration
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    customMetrics:
      - name: rabbitmq_queue_messages_ready
        targetAverageValue: "100"
  
  # Pod Disruption Budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  
  # Environment variables (non-sensitive)
  env:
    ASPNETCORE_ENVIRONMENT: "Production"
    LOG_LEVEL: "Information"
    JWT__ExpiryMinutes: "60"
  
  # Secrets (from external secret operator)
  secrets:
    enabled: true
    name: "app-secrets"

# RabbitMQ StatefulSet configuration
rabbitmq:
  enabled: true
  
  # Image configuration
  image:
    repository: "rabbitmq"
    tag: "3.12-management-alpine"
    pullPolicy: "IfNotPresent"
  
  # Replicas for high availability cluster
  replicas: 3
  
  # Resource configuration
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  
  # Storage configuration
  storage:
    size: "10Gi"
    storageClassName: "standard"
  
  # Service configuration
  service:
    type: ClusterIP
    amqpPort: 5672
    managementPort: 15672
    clusteringPort: 25672
  
  # Health checks
  healthCheck:
    liveness:
      enabled: true
      initialDelaySeconds: 60
      periodSeconds: 10
    readiness:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 5
  
  # Pod Disruption Budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  
  # Clustering configuration
  clustering:
    enabled: true
    partitionHandling: "autoheal"

# MSSQL StatefulSet configuration
mssql:
  enabled: true
  
  # Image configuration
  image:
    repository: "mcr.microsoft.com/mssql/server"
    tag: "2019-latest"
    pullPolicy: "IfNotPresent"
  
  # Replicas (1 for single instance)
  replicas: 1
  
  # Resource configuration
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "2Gi"
  
  # Storage configuration
  storage:
    dataSize: "20Gi"
    logsSize: "5Gi"
    storageClassName: "standard"
  
  # Service configuration
  service:
    type: ClusterIP
    port: 1433
  
  # Edition: Developer, Express, Standard, Enterprise
  edition: "Developer"
  
  # Health checks
  healthCheck:
    liveness:
      enabled: true
      initialDelaySeconds: 60
      periodSeconds: 30
    readiness:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10

# Prometheus configuration
prometheus:
  enabled: true
  
  # Image configuration
  image:
    repository: "prom/prometheus"
    tag: "v2.48.0"
    pullPolicy: "IfNotPresent"
  
  # Storage configuration
  storage:
    size: "20Gi"
    storageClassName: "standard"
    retention: "30d"
  
  # Service configuration
  service:
    type: ClusterIP
    port: 9090
  
  # Ingress configuration
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: "prometheus.thethroneofgames.com"
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: prometheus-tls-certificate
        hosts:
          - "prometheus.thethroneofgames.com"
  
  # Scrape configuration
  scrapeInterval: "15s"
  evaluationInterval: "15s"

# Grafana configuration
grafana:
  enabled: true
  
  # Image configuration
  image:
    repository: "grafana/grafana"
    tag: "10.2.0"
    pullPolicy: "IfNotPresent"
  
  # Storage configuration
  storage:
    size: "5Gi"
    storageClassName: "standard"
  
  # Admin credentials (from secrets)
  admin:
    user: "admin"
    secretKey: "SA_PASSWORD"
  
  # Service configuration
  service:
    type: LoadBalancer  # LoadBalancer for external access
    port: 3000
  
  # Ingress configuration
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: "grafana.thethroneofgames.com"
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: grafana-tls-certificate
        hosts:
          - "grafana.thethroneofgames.com"
  
  # Datasources configuration
  datasources:
    - name: Prometheus
      type: prometheus
      url: "http://prometheus-service:9090"
      isDefault: true

# Configuration management
configMap:
  enabled: true
  # API-specific config
  api:
    ASPNETCORE_ENVIRONMENT: "Production"
    LOG_LEVEL: "Information"
    RabbitMq__Host: "rabbitmq-service"
    RabbitMq__Port: "5672"
    RabbitMq__ExchangeName: "thethroneofgames.events"
    Database__Connection: "Host=mssql-service;Port=1433;Database=TheThroneOfGames;User Id=sa;"
    JWT__Issuer: "https://thethroneofgames.com"
    JWT__Audience: "thethroneofgames-api"

# Secrets management
secrets:
  enabled: true
  # Use external secret operator in production
  externalSecretOperator:
    enabled: false
    backend: "vault"
    vaultAddress: "https://vault.example.com"

# Network policies
networkPolicies:
  enabled: true
  defaultDeny: true

# RBAC configuration
rbac:
  enabled: true
  # Service accounts creation
  serviceAccounts:
    api:
      create: true
      name: "api-service-account"
    rabbitmq:
      create: true
      name: "rabbitmq-service-account"
    mssql:
      create: true
      name: "mssql-service-account"
    prometheus:
      create: true
      name: "prometheus-service-account"

# Node affinity and pod disruption
affinity:
  # Pod anti-affinity to spread pods across nodes
  podAntiAffinity:
    enabled: true
    preferredDuringScheduling: true

# Tolerations for node taints
tolerations: []

# Node selector
nodeSelector: {}

# Common labels for all resources
commonLabels:
  app: thethroneofgames
  managed-by: helm

# Common annotations for all resources
commonAnnotations:
  description: "TheThroneOfGames Platform"
