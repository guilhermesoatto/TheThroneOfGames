---
# Network Policy to restrict traffic
# Default deny all ingress/egress, then explicitly allow needed traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: thethroneofgames-default-deny
  namespace: thethroneofgames
  labels:
    app: thethroneofgames
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Allow API to receive traffic from LoadBalancer/Ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-ingress
  namespace: thethroneofgames
spec:
  podSelector:
    matchLabels:
      app: api
  policyTypes:
    - Ingress
  ingress:
    # Allow from Ingress Controller
    - from:
        - podSelector:
            matchLabels:
              app: ingress-nginx
      ports:
        - protocol: TCP
          port: 5000
        - protocol: TCP
          port: 9090
    # Allow from Prometheus for metrics scraping
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 5000

---
# Allow API to communicate with RabbitMQ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-to-rabbitmq
  namespace: thethroneofgames
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: api
      ports:
        - protocol: TCP
          port: 5672

---
# Allow API to communicate with MSSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-to-mssql
  namespace: thethroneofgames
spec:
  podSelector:
    matchLabels:
      app: mssql
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: api
      ports:
        - protocol: TCP
          port: 1433

---
# Allow RabbitMQ clustering
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-rabbitmq-clustering
  namespace: thethroneofgames
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: rabbitmq
      ports:
        - protocol: TCP
          port: 25672

---
# Allow Prometheus to scrape metrics from all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: thethroneofgames
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090

---
# Allow Prometheus and Grafana traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-traffic
  namespace: thethroneofgames
spec:
  podSelector:
    matchLabels:
      component: monitoring
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Prometheus scrape
    - from:
        - podSelector:
            matchLabels:
              app: api
    # Grafana from external
    - from:
        - namespaceSelector: {}
  egress:
    # Allow all egress for monitoring
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 1433

---
# Allow DNS queries (critical for service discovery)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: thethroneofgames
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS to kube-dns
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Ingress configuration for HTTP/HTTPS traffic
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-ingress
  namespace: thethroneofgames
  labels:
    app: api
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.thethroneofgames.com
      secretName: api-tls-certificate
  
  rules:
    - host: api.thethroneofgames.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-service
                port:
                  number: 80
          - path: /metrics
            pathType: Prefix
            backend:
              service:
                name: api-service
                port:
                  number: 9090

---
# Ingress for Grafana
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: thethroneofgames
  labels:
    app: grafana
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - grafana.thethroneofgames.com
      secretName: grafana-tls-certificate
  
  rules:
    - host: grafana.thethroneofgames.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana-service
                port:
                  number: 3000

---
# Ingress for Prometheus
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: thethroneofgames
  labels:
    app: prometheus
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - prometheus.thethroneofgames.com
      secretName: prometheus-tls-certificate
  
  rules:
    - host: prometheus.thethroneofgames.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-service
                port:
                  number: 9090
