---
# Service Account for API
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-service-account
  namespace: thethroneofgames
  labels:
    app: api

---
# Role for API (pod-specific permissions)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: api-role
  namespace: thethroneofgames
spec:
  rules:
    # Read own namespace
    - apiGroups: [""]
      resources: ["pods", "pods/log"]
      verbs: ["get", "list", "watch"]
    # Read configmaps and secrets in namespace
    - apiGroups: [""]
      resources: ["configmaps", "secrets"]
      verbs: ["get", "list"]
    # Read services for service discovery
    - apiGroups: [""]
      resources: ["services", "endpoints"]
      verbs: ["get", "list", "watch"]

---
# RoleBinding for API
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: api-rolebinding
  namespace: thethroneofgames
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-role
subjects:
  - kind: ServiceAccount
    name: api-service-account
    namespace: thethroneofgames

---
# Service Account for RabbitMQ
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rabbitmq-service-account
  namespace: thethroneofgames
  labels:
    app: rabbitmq

---
# Role for RabbitMQ (StatefulSet discovery)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rabbitmq-role
  namespace: thethroneofgames
spec:
  rules:
    # Read pods for clustering
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "watch"]
    # Read endpoints for headless service discovery
    - apiGroups: [""]
      resources: ["endpoints"]
      verbs: ["get", "list", "watch"]

---
# RoleBinding for RabbitMQ
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rabbitmq-rolebinding
  namespace: thethroneofgames
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rabbitmq-role
subjects:
  - kind: ServiceAccount
    name: rabbitmq-service-account
    namespace: thethroneofgames

---
# Service Account for MSSQL
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mssql-service-account
  namespace: thethroneofgames
  labels:
    app: mssql

---
# Cluster Role for monitoring/metrics (shared)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-monitoring
spec:
  rules:
    # Read nodes and pods for metrics discovery
    - apiGroups: [""]
      resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
      verbs: ["get", "list", "watch"]
    # Read metrics
    - apiGroups: ["apps"]
      resources: ["deployments", "statefulsets"]
      verbs: ["get", "list", "watch"]
    # Read ingresses
    - apiGroups: ["networking.k8s.io"]
      resources: ["ingresses"]
      verbs: ["get", "list", "watch"]

---
# Cluster Role Binding for Prometheus
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-monitoring
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: thethroneofgames
