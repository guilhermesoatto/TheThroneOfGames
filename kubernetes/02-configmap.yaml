---
# ConfigMap for API application settings
# Non-sensitive configuration that can be mounted as environment variables or files
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-config
  namespace: thethroneofgames
  labels:
    app: api
    component: configuration
data:
  ASPNETCORE_ENVIRONMENT: "Production"
  ASPNETCORE_URLS: "http://+:5000"
  LOG_LEVEL: "Information"
  
  # RabbitMQ Configuration
  RabbitMq__Host: "rabbitmq-service"
  RabbitMq__Port: "5672"
  RabbitMq__ExchangeName: "thethroneofgames.events"
  RabbitMq__DlqExchangeName: "thethroneofgames.dlq"
  RabbitMq__AutomaticRecoveryEnabled: "true"
  
  # Database Configuration
  Database__Connection: "Host=mssql-service;Port=1433;Database=TheThroneOfGames;User Id=sa;"
  
  # Prometheus Metrics
  PROMETHEUS_PORT: "9090"
  PROMETHEUS_SCRAPE_INTERVAL: "15s"
  
  # Application Settings
  JWT__Issuer: "https://thethroneofgames.com"
  JWT__Audience: "thethroneofgames-api"
  JWT__ExpiryMinutes: "60"
  
  # Resilience Policies
  Resilience__RetryAttempts: "3"
  Resilience__CircuitBreakerThreshold: "5"
  Resilience__TimeoutSeconds: "5"
  Resilience__CircuitBreakerResetSeconds: "30"

---
# ConfigMap for RabbitMQ Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: thethroneofgames
  labels:
    app: rabbitmq
    component: messaging
data:
  rabbitmq.conf: |
    default_user = guest
    default_pass = guest
    default_vhost = /
    disk_free_limit.absolute = 2GB
    vm_memory_high_watermark.relative = 0.6
    channel_max = 2048
    heartbeat = 60
    management.load_definitions = /etc/rabbitmq/definitions.json

---
# ConfigMap for Prometheus Kubernetes ServiceMonitor
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: thethroneofgames
  labels:
    app: prometheus
    component: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
          - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      
      - job_name: 'thethroneofgames-api'
        metrics_path: '/metrics'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - thethroneofgames
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: api
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            regex: '([^:]+)(?::\d+)?'
            replacement: '${1}:5000'
      
      - job_name: 'rabbitmq'
        static_configs:
          - targets: ['rabbitmq-service:15672']
        metrics_path: '/api/metrics'
        basic_auth:
          username: guest
          password: guest
