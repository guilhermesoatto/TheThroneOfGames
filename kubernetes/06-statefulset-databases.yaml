---
# StatefulSet for RabbitMQ
# Maintains stable network identity for clustering
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: thethroneofgames
  labels:
    app: rabbitmq
    component: messaging
spec:
  serviceName: rabbitmq-headless-service
  replicas: 3  # High availability cluster
  selector:
    matchLabels:
      app: rabbitmq
  
  template:
    metadata:
      labels:
        app: rabbitmq
        component: messaging
    spec:
      serviceAccountName: rabbitmq-service-account
      
      containers:
        - name: rabbitmq
          image: rabbitmq:3.12-management-alpine
          
          ports:
            - name: amqp
              containerPort: 5672
              protocol: TCP
            - name: management
              containerPort: 15672
              protocol: TCP
            - name: clustering
              containerPort: 25672
              protocol: TCP
          
          # Environment variables
          env:
            - name: RABBITMQ_DEFAULT_USER
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: RABBITMQ_DEFAULT_USER
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: RABBITMQ_DEFAULT_PASS
            - name: RABBITMQ_ERLANG_COOKIE
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: RABBITMQ_ERLANG_COOKIE
            - name: RABBITMQ_NODENAME
              value: "rabbit@rabbitmq-$(HOSTNAME)"
            - name: RABBITMQ_USE_LONGNAME
              value: "true"
            - name: RABBITMQ_CLUSTER_PARTITION_HANDLING
              value: "autoheal"
            - name: RABBITMQ_MNESIA_DIR
              value: "/var/lib/rabbitmq/mnesia"
            - name: RABBITMQ_LOGS
              value: "-"
          
          # Health checks
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - rabbitmq-diagnostics -q ping
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - rabbitmq-diagnostics -q check_running
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          # Resource limits
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            allowPrivilegeEscalation: false
          
          # Volume mounts
          volumeMounts:
            - name: rabbitmq-data
              mountPath: /var/lib/rabbitmq
            - name: rabbitmq-config
              mountPath: /etc/rabbitmq
              readOnly: true
          
          # Graceful shutdown
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    rabbit_pid=$(pgrep -f 'rabbit -W')
                    if [ -n "$rabbit_pid" ]; then
                      rabbitmqctl stop_app
                      rabbitmqctl reset
                      rabbitmqctl quit
                    fi
      
      # Pod security and affinity
      securityContext:
        fsGroup: 999
      
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - rabbitmq
              topologyKey: kubernetes.io/hostname
      
      terminationGracePeriodSeconds: 30
      
      volumes:
        - name: rabbitmq-config
          configMap:
            name: rabbitmq-config

  # Persistent volume claim for RabbitMQ data
  volumeClaimTemplates:
    - metadata:
        name: rabbitmq-data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: standard
        resources:
          requests:
            storage: 10Gi

---
# StatefulSet for MSSQL
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mssql
  namespace: thethroneofgames
  labels:
    app: mssql
    component: database
spec:
  serviceName: mssql-service
  replicas: 1  # Single MSSQL for dev/test (use Always On AG for production)
  selector:
    matchLabels:
      app: mssql
  
  template:
    metadata:
      labels:
        app: mssql
        component: database
    spec:
      serviceAccountName: mssql-service-account
      
      containers:
        - name: mssql
          image: mcr.microsoft.com/mssql/server:2019-latest
          
          ports:
            - name: sql
              containerPort: 1433
              protocol: TCP
          
          env:
            - name: MSSQL_SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: SA_PASSWORD
            - name: MSSQL_PID
              value: "Developer"  # Use Express/Standard/Enterprise as needed
            - name: ACCEPT_EULA
              value: "Y"
            - name: MSSQL_COLLATION
              value: "SQL_Latin1_General_CP1_CI_AS"
          
          # Health checks
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$MSSQL_SA_PASSWORD" -Q "SELECT 1" || exit 1
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$MSSQL_SA_PASSWORD" -Q "SELECT 1" || exit 1
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Resource limits
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          
          # Security context
          securityContext:
            runAsNonRoot: false  # MSSQL requires root
            capabilities:
              add:
                - NET_BIND_SERVICE
          
          # Volume mounts
          volumeMounts:
            - name: mssql-data
              mountPath: /var/opt/mssql/data
            - name: mssql-logs
              mountPath: /var/opt/mssql/log
      
      # Termination grace period for graceful shutdown
      terminationGracePeriodSeconds: 30
  
  # Persistent volume claims
  volumeClaimTemplates:
    - metadata:
        name: mssql-data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: standard
        resources:
          requests:
            storage: 20Gi
    
    - metadata:
        name: mssql-logs
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: standard
        resources:
          requests:
            storage: 5Gi
